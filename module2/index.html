


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="This hands-on workshop is where you will learn about a number of AWS services involved with threat detection and response as we walk through real-world threat scenarios. Learn about the threat detection capabilities of Amazon GuardDuty, Amazon Macie and AWS Security Hub and the available response options. For each hands-on scenario, we review methods to detect and respond to threats using the following services: AWS CloudTrail, Amazon VPC flow logs, Amazon CloudWatch Events, Amazon Macie, AWS Lambda, Amazon Inspector, Amazon GuardDuty and Amazon Security Hub.">
      
      
        <link rel="canonical" href="https://vul-mgmt-program.awssecworkshops.com/module2/">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      <link rel="shortcut icon" href="../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.6">
    
    
      
        <title>Module 2: AMI Factory - Build a Vulnerability Management Program Using AWS for AWS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.63b94e9e.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ami-factory" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://vul-mgmt-program.awssecworkshops.com/" title="Build a Vulnerability Management Program Using AWS for AWS" class="md-header-nav__button md-logo" aria-label="Build a Vulnerability Management Program Using AWS for AWS">
      
  <img src="../assets/images/aws_smile_logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Build a Vulnerability Management Program Using AWS for AWS
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Module 2: AMI Factory
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/aws-samples/aws-vulnerability-management-workshop/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/aws-vulnerability-management-workshop
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://vul-mgmt-program.awssecworkshops.com/" title="Build a Vulnerability Management Program Using AWS for AWS" class="md-nav__button md-logo" aria-label="Build a Vulnerability Management Program Using AWS for AWS">
      
  <img src="../assets/images/aws_smile_logo.png" alt="logo">

    </a>
    Build a Vulnerability Management Program Using AWS for AWS
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-samples/aws-vulnerability-management-workshop/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/aws-vulnerability-management-workshop
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../module1/" title="Module 1: Asset Management" class="md-nav__link">
      Module 1: Asset Management
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Module 2: AMI Factory
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Module 2: AMI Factory" class="md-nav__link md-nav__link--active">
      Module 2: AMI Factory
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ami-catalog-decisions" class="md-nav__link">
    AMI Catalog Decisions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ami-pipeline" class="md-nav__link">
    AMI Pipeline
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-an-ami-pipeline-on-aws" class="md-nav__link">
    Deploying an AMI Pipeline on AWS
  </a>
  
    <nav class="md-nav" aria-label="Deploying an AMI Pipeline on AWS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-up-the-golden-ami-pipeline-environment" class="md-nav__link">
    Set up the golden AMI pipeline environment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-golden-ami" class="md-nav__link">
    Create a golden AMI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#review-assessment-result" class="md-nav__link">
    Review assessment result
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#takeaway" class="md-nav__link">
    Takeaway
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../module3/" title="Module 3: Vulnerability Assessment" class="md-nav__link">
      Module 3: Vulnerability Assessment
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../module4/" title="Module 4: Fleet Management at Scale" class="md-nav__link">
      Module 4: Fleet Management at Scale
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contribute/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ami-catalog-decisions" class="md-nav__link">
    AMI Catalog Decisions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ami-pipeline" class="md-nav__link">
    AMI Pipeline
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-an-ami-pipeline-on-aws" class="md-nav__link">
    Deploying an AMI Pipeline on AWS
  </a>
  
    <nav class="md-nav" aria-label="Deploying an AMI Pipeline on AWS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-up-the-golden-ami-pipeline-environment" class="md-nav__link">
    Set up the golden AMI pipeline environment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-golden-ami" class="md-nav__link">
    Create a golden AMI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#review-assessment-result" class="md-nav__link">
    Review assessment result
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#takeaway" class="md-nav__link">
    Takeaway
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/aws-vulnerability-management-workshop/edit/master/docs/module2/index.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="ami-factory">AMI Factory</h1>
<p>In a typical enterprise scenario, a cloud team is responsible
for providing the core infrastructure services to development teams, which includes creation of approved AMIs with the latest OS updates, hardening requirements, and required third-party software agents.</p>
<h2 id="ami-catalog-decisions">AMI Catalog Decisions</h2>
<p>AMI design options differ based on the trade-offs of deployment simplicity versus deployment flexibility. The simplest AMIs are fully baked and purpose-built to deploy a complete running instance, including the installation and configuration of all required software. However, this approach limits flexibility, as a fully baked AMI can only be used to deploy a single instance or a farm of identical instances. The most flexible AMIs include only minimal configurations and software, requiring application specific packages to be installed on first boot. This approach trades simplicity for flexibility as each instance must be properly bootstrapped before it can function as intended.</p>
<p>The ideal AMI design depends largely on the constraints of the workload. When considering which option is right for your organization, keep the following questions in mind:</p>
<ul>
<li>How quickly do you need to be able to replace a failing instance or add additional compute capacity?</li>
<li>Is the workload spikey or static?</li>
<li>Does your server configuration require manual provisioning or configuration?</li>
<li>Do you need to minimize the complexity of deploying resources to both AWS and on-premises environments?</li>
<li>Are there existing server provisioning tools or processes that you are trying to align with AWS?</li>
</ul>
<p><img alt="AMI Flexibility vs Simplicity" src="images/ami-design-tradeoff.png" /></p>
<p>In this exercise, we will build out the scripts needed to configure the AMI as CIS level 1 compliant, validate that the AMI is actually CIS compliant with Amazon Inspector and look for vulnerabilities from the CVE database. We are going with the JeOS (just enough Operating System) option for AMI design.</p>
<h2 id="ami-pipeline">AMI Pipeline</h2>
<p>Here's a high-level workflow diagram of the golden AMI pipeline:</p>
<p><img alt="Golden AMI Pipeline" src="images/WorkflowDiagram.png" /></p>
<p>Here's what our AMI pipeline solution looks like that we will be deploying today:</p>
<p><img alt="Arch Diagram" src="images/ArchitectureDiagram.PNG" /></p>
<h2 id="deploying-an-ami-pipeline-on-aws">Deploying an AMI Pipeline on AWS</h2>
<p>You can use an AWS Systems Manager (SSM) document to configure the AMI according to your organisation's security standards such as CIS, NIST, etc. An AWS Systems Manager document (SSM document) defines the actions that Systems Manager performs on your managed instances. Systems Manager includes more than a dozen pre-configured documents that you can use by specifying parameters at runtime. Documents use JSON or YAML, and they include steps and parameters that you specify.</p>
<h3 id="set-up-the-golden-ami-pipeline-environment">Set up the golden AMI pipeline environment</h3>
<details class="info"><summary>Click here if you're running this individually in your own AWS Account</summary><p>Launch the CloudFormation stack below to setup the Golden AMI Pipeline Solution:</p>
<table>
<thead>
<tr>
<th>Region</th>
<th>Deploy</th>
</tr>
</thead>
<tbody>
<tr>
<td>US East 2 (Ohio)</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/new?stackName=Vuln-Mngmt-Wksp-Module-2-Golden-AMI-Compliance&templateURL=https://wkshp-avmw-cfn-templates-q3klzl70esd4zsc6.s3.us-east-2.amazonaws.com/Golden-AMI-ComplianceCFT.yml" target="_blank"><img alt="Deploy in us-east-2" src="images/deploy-to-aws.png" /></a></td>
</tr>
</tbody>
</table>
<ol>
<li>
<p>Click the <strong>Deploy to AWS</strong> button above (right click and open in a new tab).  This will automatically take you to the console to run the template.  </p>
</li>
<li>
<p>Click <strong>Next</strong> on the <strong>Specify Template</strong> section.</p>
</li>
<li>
<p><span style="background-color: #FFFF00">On the <strong>Specify Details</strong> step enter a <strong>valid</strong> Email Address and your Role/User.</span></p>
</li>
<li>
<p>On the <strong>Specify Details</strong> step, fill in the parameters based on the table below and then click <strong>Next</strong>.</p>
</li>
<li>
<p>Click <strong>Next</strong> on the <strong>Options</strong> section.</p>
</li>
<li>Finally, acknowledge that the template will create IAM roles under <strong>Capabilities</strong> and click <strong>Create</strong>.</li>
</ol>
<p>This will bring you back to the CloudFormation console. You can refresh the page to see the stack starting to create. Before moving on, make sure the stack is in a <strong>CREATE_COMPLETE</strong>.</p>
</details>
<div class="admonition warning">
<p class="admonition-title">Values are case-sensitive</p>
</div>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ApproverARN</strong></td>
<td><span style="background-color: #FFFF00"><strong>[REQUIRED]</strong></span></td>
<td>AWS authenticated principals who are able to either approve or reject the Golden AMI. You can specify principals by using an AWS Identity and Access Management (IAM) user name, IAM user ARN, IAM role ARN, or an IAM assume role user ARN.</td>
</tr>
<tr>
<td><strong>EmailID</strong></td>
<td><span style="background-color: #FFFF00"><strong>[REQUIRED]</strong></span></td>
<td>This is the Email ID of the administrator responsible for validating the continuous assessment results</td>
</tr>
<tr>
<td>buildVersion</td>
<td>1</td>
<td>This is a default version that corresponds to your product. You will override this value when you trigger golden AMI creation/distribution/ decommissioning automation workflow</td>
</tr>
<tr>
<td>continuousInspection Frequency</td>
<td>rate (1 day)</td>
<td>This is the frequency at which vulnerability assessment of your active AMIs would take place</td>
</tr>
<tr>
<td>instanceType</td>
<td>t2.large</td>
<td>This is the InstanceType that is compatible with all your golden AMIs</td>
</tr>
<tr>
<td>productName</td>
<td>DevOpsAMI-1.0</td>
<td>This is the name of the golden AMI product along with major/minor version number. The syntax of this parameter is ProductName-ProductVersion</td>
</tr>
<tr>
<td>productOSAndVersion</td>
<td>AmazonLinux-2018.11</td>
<td>The syntax of this parameter is OSName-OSVersion. This is the default OS and version number of the OS</td>
</tr>
</tbody>
</table>
<p>You will see following parameters in the output. Note the value of the parameters.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GoldenAMIAutomationDoc</td>
<td>The name of the SSM automation document you can execute for generating a golden AMI</td>
</tr>
<tr>
<td>DecommissionAMIVersionDoc</td>
<td>The name of the SSM automation document you can execute for decommissioning a golden AMI</td>
</tr>
<tr>
<td>ContinuousInspectionScheduledRule</td>
<td>The CloudWatch Events rule that executes continuous vulnerability assessment at the frequency you specified</td>
</tr>
<tr>
<td>BucketName</td>
<td>The name of the Amazon S3 bucket in which you need to upload CloudFormation Template for launching your golden AMI</td>
</tr>
<tr>
<td>ContinuousAssessmentResultsTopic</td>
<td>The SNS topic on which continuous assessment results will be published</td>
</tr>
</tbody>
</table>
<h3 id="create-a-golden-ami">Create a golden AMI</h3>
<ol>
<li>Navigate to <strong>Systems Manager</strong> console</li>
<li>In the navigation panel, choose <strong>Automation</strong> under <strong>Actions &amp; Change</strong> drop-down.</li>
<li>Choose <strong>Execute Automation</strong>.
<img alt="SSM Automation" src="images/ssmautomationexecution.png" /></li>
<li>Filter the automations by clicking the <strong>Owned by me</strong> tab. Make sure you are in the Ohio region.
<img alt="Filter Automation" src="images/filterautomationdocs.png" /></li>
<li>Choose the <em>GoldenAMIAutomationDoc</em> document name that you noted in the output tab of CloudFormation stack and click Next.</li>
<li>
<p>Choose following values:</p>
<ul>
<li>Select <strong>Simple Execution</strong>
<img alt="SSM Execution" src="images/ssm-execution.png" /></li>
<li>Most input parameters will be pre-populated except the sourceAMIid and AMIVersion. We will be querying for the latest AMI IDs using AWS Systems Manager Parameter Store. You can see we have used the Amazon Linux Public AMI Parameter.
<img alt="Automation AMI" src="images/automationamiid.png" />
You can find more information on querying for the latest AMI IDs at the following links</li>
<li><a href="https://aws.amazon.com/blogs/compute/query-for-the-latest-amazon-linux-ami-ids-using-aws-systems-manager-parameter-store/" target="_blank">Query for the latest Amazon Linux AMI IDs using AWS Systems Manager Parameter Store</a></li>
<li><a href="https://aws.amazon.com/blogs/mt/query-for-the-latest-windows-ami-using-systems-manager-parameter-store/" target="_blank">Query for the Latest Windows AMI Using Systems Manager Parameter Store</a></li>
<li>We do the same with a Windows 2016 Base AMI by following the same steps again.
<img alt="Automation Windows" src="images/automationWindowsamiid.png" /></li>
</ul>
</li>
<li>
<p>You can leave remaining parameters as it is. Automation document launches instances in a private subnet, with a security group that has no inbound access for launching instances.</p>
</li>
<li>Next, click on <strong>Execute</strong>.</li>
</ol>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The process may take approximately 30 minutes to 1.5 hours depending upon the available number of updates and scripts executed on the AMI. You can either schedule it to run periodically OR trigger it manually OR trigger it at the end of your CI-CD pipeline.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>For this lab we recommend using a Amazon Linux 2 AMI. You may choose a Windows AMI as well but in the interest of time, you can move on to the next section of the lab while the automation is working in the background.</p>
</div>
<p>Here is how the process works:</p>
<ol>
<li>The process takes a source AMI, creates an instance, updates packages, and executes your custom code for hardening the instance and installing required agents.</li>
<li>Next, it stops the instance and creates an image from the stopped instance.</li>
<li>Since the security posture of an AMI can be assessed based on the security posture of an instance, automation creates an EC2 instance from the newly created golden AMI.</li>
<li>It then installs an Amazon Inspector agent on the EC2 instance and triggers an Amazon Inspector assessment. The Amazon Inspector assessment setup evaluates following rules packages:<ul>
<li><a href="https://docs.aws.amazon.com/inspector/latest/userguide/inspector_cves.html" target="_blank">Common Vulnerabilities and Exposures (CVEs)</a></li>
<li><a href="https://docs.aws.amazon.com/inspector/latest/userguide/inspector_cis.html" target="_blank">Center for Internet Security (CIS) Benchmarks</a></li>
<li><a href="https://docs.aws.amazon.com/inspector/latest/userguide/inspector_security-best-practices.html" target="_blank">AWS Security Best Practices</a></li>
<li><a href="https://docs.aws.amazon.com/inspector/latest/userguide/inspector_runtime-behavior-analysis.html" target="_blank">Runtime Behavior Analysis</a></li>
</ul>
</li>
<li>Once the assessment is complete, Amazon Inspector records findings and publishes an SNS notification.</li>
<li>Since your email-ID was subscribed to the SNS topic, you will receive a notification email containing information like shown below.
<img alt="AMI Approval" src="images/AMIApproval.PNG" /></li>
</ol>
<h3 id="review-assessment-result">Review assessment result</h3>
<ol>
<li>Navigate to Systems Manager service.</li>
<li>Ensure that you are in the correct region (US-East-2).</li>
<li>In the navigation panel, choose <strong>Parameter Store</strong> under <strong>Application Management</strong> drop-down.</li>
<li>Filter parameters by using a <em>Name : begins-with</em> filter and enter the path specified in the notification.
<img alt="Param Store" src="images/ParameterStore.PNG" /></li>
<li>Choose the result.</li>
<li>Review the Value. The following value suggests that there were security findings found in the AMI.
<img alt="SSM Value" src="images/SSMValue.png" /></li>
<li>To review findings, open the Inspector service console.</li>
<li>The dashboard will display recent assessment runs. Choose the assessment run corresponding to your golden AMI.
<img alt="Inspector Results" src="images/InspectorResults.png" /></li>
<li>You can either choose Download report to see details of the finding or you can review the information by choosing the number under the Findings column.</li>
</ol>
<p>Based on what you see, you can choose to Approve or Deny the AMI. If you approved the golden AMI, you will see a new private golden AMI registered under your AMIs in the Amazon EC2 console.</p>
<p>Every time you create a new version of the golden AMI, ensure that you have specified a consistent product-name as well as the operating system.</p>
<p>We suggest that customers trigger this automation at least every 30 days. This ensures that they are pulling the latest image with updates and patches applied. We then suggest configuring it to your standards and distributing it to your application teams with a sufficient window to test their applications in a staging environment before going live.</p>
<p>This pattern of “rehydrating” your Production environment with an automated release of an updated full-stack application is called a Blue-Green deployment. At a high level it looks like the image below:</p>
<p><img alt="Blue Green" src="images/bluegreen.png" /></p>
<div class="admonition tip">
<p class="admonition-title">You can read more about these design patterns at the following links</p>
<ul>
<li><a href="https://d1.awsstatic.com/whitepapers/AWS_Blue_Green_Deployments.pdf" target="_blank">AWS Blue Green Deployments White Paper</a></li>
<li><a href="https://aws.amazon.com/blogs/devops/bluegreen-infrastructure-application-deployment-blog/" target="_blank">Automating Blue/Green Deployments of Infrastructure and Application Code using AMIs, AWS Developer Tools, &amp; Amazon EC2 Systems Manager]</a></li>
</ul>
</div>
<h2 id="takeaway">Takeaway</h2>
<p>You have now deployed an AMI baking pipeline that uses AWS Systems Manager (SSM) to configure the base AMI according to your security requirements and assessed it for vulnerabilities.</p>
<p>If you approved your AMI, navigate to the EC2 Console:</p>
<ol>
<li>Click Launch Instances</li>
<li>
<p>Click on My AMIs
<img alt="My AMI" src="images/MyAMI.png" /></p>
</li>
<li>
<p>Select the AMI created by the automation process and launch without a key pair.</p>
</li>
</ol>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../module1/" title="Module 1: Asset Management" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Module 1: Asset Management
              </div>
            </div>
          </a>
        
        
          <a href="../module3/" title="Module 3: Vulnerability Assessment" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Module 3: Vulnerability Assessment
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            <a href="https://aws.amazon.com/privacy/" target="_blank">Privacy</a> | <a href="https://aws.amazon.com/terms/" target="_blank">Site terms</a> | &copy; 2020, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://awssecworkshops.com" target="_blank" rel="noopener" title="awssecworkshops.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M280.37 148.26L96 300.11V464a16 16 0 0016 16l112.06-.29a16 16 0 0015.92-16V368a16 16 0 0116-16h64a16 16 0 0116 16v95.64a16 16 0 0016 16.05L464 480a16 16 0 0016-16V300L295.67 148.26a12.19 12.19 0 00-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 00-12-12h-56a12 12 0 00-12 12v72.61L318.47 43a48 48 0 00-61 0L4.34 251.47a12 12 0 00-1.6 16.9l25.5 31A12 12 0 0045.15 301l235.22-193.74a12.19 12.19 0 0115.3 0L530.9 301a12 12 0 0016.9-1.6l25.5-31a12 12 0 00-1.7-16.93z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M466.5 83.7l-192-80a48.15 48.15 0 00-36.9 0l-192 80C27.7 91.1 16 108.6 16 128c0 198.5 114.5 335.7 221.5 380.3 11.8 4.9 25.1 4.9 36.9 0C360.1 472.6 496 349.3 496 128c0-19.4-11.7-36.9-29.5-44.3zM256.1 446.3l-.1-381 175.9 73.3c-3.3 151.4-82.1 261.1-175.8 307.7z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/awssecurityinfo?lang=en" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/blogs/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM112 416c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm157.533 0h-34.335c-6.011 0-11.051-4.636-11.442-10.634-5.214-80.05-69.243-143.92-149.123-149.123-5.997-.39-10.633-5.431-10.633-11.441v-34.335c0-6.535 5.468-11.777 11.994-11.425 110.546 5.974 198.997 94.536 204.964 204.964.352 6.526-4.89 11.994-11.425 11.994zm103.027 0h-34.334c-6.161 0-11.175-4.882-11.427-11.038-5.598-136.535-115.204-246.161-251.76-251.76C68.882 152.949 64 147.935 64 141.774V107.44c0-6.454 5.338-11.664 11.787-11.432 167.83 6.025 302.21 141.191 308.205 308.205.232 6.449-4.978 11.787-11.432 11.787z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>