



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="This hands-on workshop is where you will learn about a number of AWS services involved with threat detection and response as we walk through real-world threat scenarios. Learn about the threat detection capabilities of Amazon GuardDuty, Amazon Macie and AWS Security Hub and the available response options. For each hands-on scenario, we review methods to detect and respond to threats using the following services: AWS CloudTrail, Amazon VPC flow logs, Amazon CloudWatch Events, Amazon Macie, AWS Lambda, Amazon Inspector, Amazon GuardDuty and Amazon Security Hub.">
      
      
        <link rel="canonical" href="https://vul-mgmt-program.awssecworkshops.com/module2/">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Module 2 - Build a Vulnerability Management Program Using AWS for AWS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.0284f74d.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#ami-factory" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">
  
        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>
  
        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>
  
        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Build a Vulnerability Management Program Using AWS for AWS
                </span>
                <span class="md-header-nav__topic">
                  Module 2
                </span>
              
            
          </div>
        </div>
        
        
        <!-- Button to open search dialogue -->
        <!--
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>
  
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>

         -->
         
         <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-flex__ellipsis md-header-nav__lang">
                <div>
                    <button onclick="window.location.href = 'https://awssecworkshops.com/';" class="md-lang-dropbtn fa fa-home"></button>
                </div>
            </div>
        </div>
  
        <!-- Repository containing source -->
        
          <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__source">
              


  

<a href="https://github.com/aws-samples/aws-vulnerability-management-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/aws-vulnerability-management-workshop
  </div>
</a>
            </div>
          </div>
        
      </div>
    </nav>
  </header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." title="Overview" class="md-tabs__link">
        Overview
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../module1/" title="Asset Management and Tagging" class="md-tabs__link">
          Asset Management and Tagging
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="./" title="AMI Factory" class="md-tabs__link md-tabs__link--active">
          AMI Factory
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../module3/" title="Vulnerability Assessment and Patch Manager Setup" class="md-tabs__link">
          Vulnerability Assessment and Patch Manager Setup
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../module4/" title="EC2 Fleet Management at Scale" class="md-tabs__link">
          EC2 Fleet Management at Scale
        </a>
      
    </li>
  

      
        
      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <!--
  Copyright (c) 2016-2019 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Main navigation -->
<nav class="md-nav md-nav--primary" data-md-level="0">

  <!-- Site title -->
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://vul-mgmt-program.awssecworkshops.com/"
        title="Build a Vulnerability Management Program Using AWS for AWS" class="md-nav__button md-logo">
      
        <img src="../assets/images/aws_smile_logo.png" width="48" height="48" />
      
    </a>
    Build a Vulnerability Management Program
  </label>

  <!-- Repository containing source -->
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/aws-samples/aws-vulnerability-management-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/aws-vulnerability-management-workshop
  </div>
</a>
    </div>
  

  <!-- Render item list -->
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Asset Management and Tagging
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Asset Management and Tagging
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../module1/" title="Module 1" class="md-nav__link">
      Module 1
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      AMI Factory
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        AMI Factory
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Module 2
      </label>
    
    <a href="./" title="Module 2" class="md-nav__link md-nav__link--active">
      Module 2
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ami-catalog-decisions" title="AMI Catalog Decisions" class="md-nav__link">
    AMI Catalog Decisions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ami-pipeline" title="AMI Pipeline" class="md-nav__link">
    AMI Pipeline
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-an-ami-pipeline-on-aws" title="Deploying an AMI Pipeline on AWS" class="md-nav__link">
    Deploying an AMI Pipeline on AWS
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-up-the-golden-ami-pipeline-environment" title="Set up the golden AMI pipeline environment" class="md-nav__link">
    Set up the golden AMI pipeline environment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-golden-ami" title="Create a golden AMI" class="md-nav__link">
    Create a golden AMI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#review-assessment-result" title="Review assessment result" class="md-nav__link">
    Review assessment result
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#takeaway" title="Takeaway" class="md-nav__link">
    Takeaway
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Vulnerability Assessment and Patch Manager Setup
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Vulnerability Assessment and Patch Manager Setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../module3/" title="Module 3" class="md-nav__link">
      Module 3
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      EC2 Fleet Management at Scale
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        EC2 Fleet Management at Scale
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../module4/" title="Module 4" class="md-nav__link">
      Module 4
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contribute/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ami-catalog-decisions" title="AMI Catalog Decisions" class="md-nav__link">
    AMI Catalog Decisions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ami-pipeline" title="AMI Pipeline" class="md-nav__link">
    AMI Pipeline
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-an-ami-pipeline-on-aws" title="Deploying an AMI Pipeline on AWS" class="md-nav__link">
    Deploying an AMI Pipeline on AWS
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-up-the-golden-ami-pipeline-environment" title="Set up the golden AMI pipeline environment" class="md-nav__link">
    Set up the golden AMI pipeline environment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-golden-ami" title="Create a golden AMI" class="md-nav__link">
    Create a golden AMI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#review-assessment-result" title="Review assessment result" class="md-nav__link">
    Review assessment result
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#takeaway" title="Takeaway" class="md-nav__link">
    Takeaway
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/aws-vulnerability-management-workshop/edit/master/docs/module2/index.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="ami-factory">AMI Factory</h1>
<p>In a typical enterprise scenario, a cloud team is responsible for providing the core infrastructure services. This team owns providing the appropriate AWS environment for the many development teams and approved AMIs that include the latest OS updates, hardening requirements, and required third-party software agents.</p>
<h2 id="ami-catalog-decisions">AMI Catalog Decisions</h2>
<p>AMI design options fall along a spectrum of deployment simplicity in relation to deployment flexibility. The simplest AMIs are fully baked and purpose-built to deploy a complete running instance, including the installation and configuration of all required software. However, this approach limits flexibility, as a fully baked AMI can only be used to deploy a single instance or a farm of identical instances. The most flexible AMIs include only minimal configurations and software before then dynamically installing the required packages on first boot. This approach trades simplicity for flexibility as each instance must be properly bootstrapped before it can function as intended.</p>
<p>The ideal AMI design depends largely on the constraints of the workload. When considering which option is right for your organization, keep the following questions in mind:</p>
<ul>
<li>How quickly do you need to be able to recover a failing instance or add additional compute capacity?</li>
<li>Does the workload’s baseline stay static for a relatively long period?</li>
<li>Does your server configuration require manual provisioning or configuration?</li>
<li>Do you need to minimize the complexity of deploying resources to both AWS and on-premises environments?</li>
<li>Are there existing server provisioning tools or processes that you are trying to align with AWS?</li>
</ul>
<p><img alt="AMI Flexibility vs Simplicity" src="images/ami-design-tradeoff.png" /></p>
<p>In this exercise, we will build out the scripts needed to configure the AMI as CIS level 1 compliant, validate that the AMI is actually CIS compliant with Amazon Inspector and look for vulnerabilities from the CVE database. We are going with the JeOS (just enough Operating System) option for AMI design.</p>
<h2 id="ami-pipeline">AMI Pipeline</h2>
<p>Here's a high-level workflow diagram of the golden AMI pipeline:</p>
<p><img alt="Golden AMI Pipeline" src="images/WorkflowDiagram.png" /></p>
<p>Here's what our AMI pipeline solution looks like that we will be deploying today:</p>
<p><img alt="Arch Diagram" src="images/ArchitectureDiagram.PNG" /></p>
<h2 id="deploying-an-ami-pipeline-on-aws">Deploying an AMI Pipeline on AWS</h2>
<p>We use an AWS Systems Manager (SSM) document to configure the AMI according to the Org’s security standards and other standards such as CIS, NIST, etc. An AWS Systems Manager document (SSM document) defines the actions that Systems Manager performs on your managed instances. Systems Manager includes more than a dozen pre-configured documents that you can use by specifying parameters at runtime. Documents use JavaScript Object Notation (JSON) or YAML, and they include steps and parameters that you specify.</p>
<h3 id="set-up-the-golden-ami-pipeline-environment">Set up the golden AMI pipeline environment</h3>
<details class="info"><summary>Click here if you're running this individually in your own AWS Account</summary><p>Launch the CloudFormation stack below to setup the Golden AMI Pipeline Solution:</p>
<table>
<thead>
<tr>
<th>Region</th>
<th>Deploy</th>
</tr>
</thead>
<tbody>
<tr>
<td>US East 2 (Ohio)</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/new?stackName=Vuln-Mngmt-Wksp-Module-2-Golden-AMI-Compliance&templateURL=https://sec337-reinvent.s3.us-east-2.amazonaws.com/Templates/Golden-AMI-ComplianceCFT.template" target="_blank"><img alt="Deploy in us-east-2" src="images/deploy-to-aws.png" /></a></td>
</tr>
</tbody>
</table>
<ol>
<li>
<p>Click the <strong>Deploy to AWS</strong> button above (right click and open in a new tab).  This will automatically take you to the console to run the template.  </p>
</li>
<li>
<p>Click <strong>Next</strong> on the <strong>Specify Template</strong> section.</p>
</li>
<li>
<p>On the <strong>Specify Details</strong> step click <strong>Next</strong>. </p>
</li>
<li>
<p>Click <strong>Next</strong> on the <strong>Options</strong> section.</p>
</li>
<li>Finally, acknowledge that the template will create IAM roles under <strong>Capabilities</strong> and click <strong>Create</strong>.</li>
</ol>
<p>This will bring you back to the CloudFormation console. You can refresh the page to see the stack starting to create. Before moving on, make sure the stack is in a <strong>CREATE_COMPLETE</strong>.</p>
</details>
<ol>
<li>On the Specify Details page, specify the following parameters (values are case-sensitive):</li>
</ol>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ApproverARN</td>
<td>awsstudent</td>
<td>AWS authenticated principals who are able to either approve or reject the Golden AMI. You can specify principals by using an AWS Identity and Access Management (IAM) user name, IAM user ARN, IAM role ARN, or an IAM assume role user ARN.</td>
</tr>
<tr>
<td>continuousInspection Frequency</td>
<td>rate (1 day)</td>
<td>This is the frequency at which vulnerability assessment of your active AMIs would take place</td>
</tr>
<tr>
<td>instanceType</td>
<td>t2.large</td>
<td>This is the InstanceType that is compatible with all your golden AMIs</td>
</tr>
<tr>
<td>EmailID</td>
<td></td>
<td>This is the Email ID of the administrator responsible for validating the continuous assessment results</td>
</tr>
<tr>
<td>productName</td>
<td>DevOpsAMI-1.0</td>
<td>This is the name of the golden AMI product along with major/minor version number. The syntax of this parameter is ProductName-ProductVersion</td>
</tr>
<tr>
<td>productOSAndVersion</td>
<td>AmazonLinux-2018.11</td>
<td>The syntax of this parameter is OSName-OSVersion. This is the default OS and version number of the OS</td>
</tr>
<tr>
<td>buildVersion</td>
<td>1</td>
<td>This is a default version that corresponds to your product. You will override this value when you trigger golden AMI creation/distribution/ decommissioning automation workflow</td>
</tr>
</tbody>
</table>
<ol>
<li>Click Next and Next again on the next page before clicking Choose Create. Remember to check the box to acknowledge that AWS CloudFormation might create IAM resources</li>
<li>After CloudFormation creates the stack, choose the check-box next to your stack and then choose Outputs tab.</li>
</ol>
<p>You will see following parameters in the output. Note the value of the parameters.</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GoldenAMIAutomationDoc</td>
<td>The name of the SSM automation document you can execute for generating a golden AMI</td>
</tr>
<tr>
<td>DecommissionAMIVersionDoc</td>
<td>The name of the SSM automation document you can execute for decommissioning a golden AMI</td>
</tr>
<tr>
<td>ContinuousInspectionScheduledRule</td>
<td>The CloudWatch Events rule that executes continuous vulnerability assessment at the frequency you specified</td>
</tr>
<tr>
<td>BucketName</td>
<td>The name of the Amazon S3 bucket in which you need to upload CloudFormation Template for launching your golden AMI</td>
</tr>
<tr>
<td>ContinuousAssessmentResultsTopic</td>
<td>The SNS topic on which continuous assessment results will be published</td>
</tr>
</tbody>
</table>
<h3 id="create-a-golden-ami">Create a golden AMI</h3>
<ol>
<li>Navigate to <strong>Systems Manager</strong> service</li>
<li>In the navigation panel, choose <strong>Automation</strong> under <strong>Actions &amp; Change</strong> drop-down.</li>
<li>Choose <strong>Execute Automation</strong>.
<img alt="SSM Automation" src="images/ssmautomationexecution.png" /></li>
<li>Filter automations visible by choosing <strong>Owner</strong> and <strong>owned by me</strong> filter option. Make sure you are in the Ohio region.
<img alt="Filter Automation" src="images/filterautomationdocs.png" /></li>
<li>Choose the <em>GoldenAMIAutomationDoc</em> document name that you noted in the output tab of CloudFormation stack.</li>
<li>Click Execute automation
<img alt="Execution Automation" src="images/executeautomation.png" /></li>
<li>
<p>Choose following values:</p>
<ul>
<li>Select <strong>Simple Execution</strong>
<img alt="SSM Execution" src="images/ssm-execution.png" /></li>
<li>Most input parameters will be pre-populated except the sourceAMIid and AMIVersion. We will be querying for the latest AMI IDs using AWS Systems Manager Parameter Store. You can see I have used the Amazon Linux Public AMI Parameter.
<img alt="Automation AMI" src="images/automationamiid.png" />
You can find more information on querying for the latest AMI IDs at the following links</li>
<li><a href="https://aws.amazon.com/blogs/compute/query-for-the-latest-amazon-linux-ami-ids-using-aws-systems-manager-parameter-store/">Query for the latest Amazon Linux AMI IDs using AWS Systems Manager Parameter Store</a></li>
<li><a href="https://aws.amazon.com/blogs/mt/query-for-the-latest-windows-ami-using-systems-manager-parameter-store/">Query for the Latest Windows AMI Using Systems Manager Parameter Store</a></li>
</ul>
<p>I do the same with a Windows 2016 Base AMI by following the same steps again.
<img alt="Automation Windows" src="images/automationWindowsamiid.png" /></p>
</li>
<li>
<p>You can leave remaining parameters as it is. Automation document launches instances in a private subnet, with a security group that has no inbound access for launching instances.</p>
</li>
<li>Next, choose Execute Automation.</li>
</ol>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The process may take approximately 30 minutes to 1.5 hours depending upon the available number of updates and scripts executed on the AMI. You can either schedule it to run periodically OR trigger it manually OR trigger it at the end of your CI-CD pipeline.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>For this lab we recommend using a Amazon Linux 2 AMI. You may choose a Windows AMI as well but in the interest of time, you can move on to the next section of the lab while the automation is working in the background.</p>
</div>
<p>Here is how the process works:</p>
<ol>
<li>The process takes a source AMI, creates an instance, updates packages, and executes your custom code for hardening the instance and installing required agents.</li>
<li>Next, it stops the instance and creates an image from the stopped instance.</li>
<li>Since the security posture of an AMI can be assessed based on the security posture of an instance, automation creates an EC2 instance from the newly created golden AMI.</li>
<li>It then installs an Amazon Inspector agent on the EC2 instance and triggers an Amazon Inspector assessment. The Amazon Inspector assessment setup evaluates following rules packages:<ul>
<li><a href="https://docs.aws.amazon.com/inspector/latest/userguide/inspector_cves.html">Common Vulnerabilities and Exposures (CVEs)</a></li>
<li><a href="https://docs.aws.amazon.com/inspector/latest/userguide/inspector_cis.html">Center for Internet Security (CIS) Benchmarks</a></li>
<li><a href="https://docs.aws.amazon.com/inspector/latest/userguide/inspector_security-best-practices.html">AWS Security Best Practices</a></li>
<li><a href="https://docs.aws.amazon.com/inspector/latest/userguide/inspector_runtime-behavior-analysis.html">Runtime Behavior Analysis</a></li>
</ul>
</li>
<li>Once the assessment is complete, Amazon Inspector records findings and publishes an SNS notification.</li>
<li>Since your email-ID was subscribed to the SNS topic, you will receive a notification email containing information like shown below.
<img alt="AMI Approval" src="images/AMIApproval.PNG" /></li>
</ol>
<h3 id="review-assessment-result">Review assessment result</h3>
<ol>
<li>Navigate to Systems Manager service.</li>
<li>Ensure that you are in the correct region (US-East-2).</li>
<li>In the navigation panel, choose <strong>Parameter Store</strong> under <strong>Shared Resources</strong> drop-down.</li>
<li>Filter parameters by using a <em>Name : begins-with</em> filter and specify the path specified in the notification.
<img alt="Param Store" src="images/ParameterStore.PNG" /></li>
<li>Choose the result.</li>
<li>Review the Value. The following value suggests that there were security findings found in the AMI.
<img alt="SSM Value" src="images/SSMValue.PNG" /></li>
<li>To review findings, open the Inspector service console.</li>
<li>The dashboard will display recent assessment runs. Choose the assessment run corresponding to your golden AMI.
<img alt="Inspector Results" src="images/InspectorResults.png" /></li>
<li>You can either choose Download report to see details of the finding or you can review the information by choosing the number under the Findings column.</li>
</ol>
<p>Based on what you see, you can choose to Approve or Deny the AMI. If you approved the golden AMI, you will see a new private golden AMI registered under your AMIs in the Amazon EC2 console.</p>
<p>Every time you create a new version of the golden AMI, ensure that you have specified the consistent product-name as well as the operating system.</p>
<p>Our largest customers typically run trigger this automation every 30 days. This ensures that you are pulling the latest image from the marketplace with updates and patches applied, configuring it to your standards and distributing it to your application teams with a sufficient window to test their applications in a staging environment before going live.</p>
<p>This pattern of “rehydrating” your Production environment with a automated release of an updated full-stack application is called a Blue-Green deployment. At a high level it looks like the image below:</p>
<p><img alt="Blue Green" src="images/bluegreen.png" /></p>
<div class="admonition tip">
<p class="admonition-title">You can read more about these design patterns at the following links</p>
<ul>
<li><a href="https://d1.awsstatic.com/whitepapers/AWS_Blue_Green_Deployments.pdf">AWS Blue Green Deployments White Paper</a></li>
<li><a href="https://aws.amazon.com/blogs/devops/bluegreen-infrastructure-application-deployment-blog/">Automating Blue/Green Deployments of Infrastructure and Application Code using AMIs, AWS Developer Tools, &amp; Amazon EC2 Systems Manager</a></li>
</ul>
</div>
<h2 id="takeaway">Takeaway</h2>
<p>You have now deployed an AMI baking pipeline that uses AWS Systems Manager (SSM) to configure the base AMI according to your security requirements and assess it for vulnerabilities.</p>
<p>From your EC2 console:</p>
<ol>
<li>Click Launch Instances</li>
<li>
<p>Click on My AMIs
<img alt="My AMI" src="images/MyAMI.png" /></p>
</li>
<li>
<p>You can see the AMI created from the automation process.</p>
</li>
<li>Select the AMI and launch without a key pair.</li>
</ol>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../module1/" title="Module 1" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Module 1
              </span>
            </div>
          </a>
        
        
          <a href="../module3/" title="Module 3" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Module 3
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://awssecworkshops.com" class="md-footer-social__link fa fa-home"></a>
    
      <a href="https://aws.amazon.com/security/" class="md-footer-social__link fa fa-shield"></a>
    
      <a href="https://twitter.com/awssecurityinfo?lang=en" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://aws.amazon.com/blogs/security/" class="md-footer-social__link fa fa-rss"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>