



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="This hands-on workshop is where you will learn about a number of AWS services involved with threat detection and response as we walk through real-world threat scenarios. Learn about the threat detection capabilities of Amazon GuardDuty, Amazon Macie and AWS Security Hub and the available response options. For each hands-on scenario, we review methods to detect and respond to threats using the following services: AWS CloudTrail, Amazon VPC flow logs, Amazon CloudWatch Events, Amazon Macie, AWS Lambda, Amazon Inspector, Amazon GuardDuty and Amazon Security Hub.">
      
      
        <link rel="canonical" href="https://vul-mgmt-program.awssecworkshops.com/module3/indexv0/">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Indexv0 - Build a Vulnerability Management Program Using AWS for AWS</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.0284f74d.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#vulnerability-assessment-and-patch-manager-setup" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">
  
        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>
  
        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>
  
        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Build a Vulnerability Management Program Using AWS for AWS
                </span>
                <span class="md-header-nav__topic">
                  Indexv0
                </span>
              
            
          </div>
        </div>
        
        
        <!-- Button to open search dialogue -->
        <!--
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>
  
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>

         -->
         
         <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-flex__ellipsis md-header-nav__lang">
                <div>
                    <button onclick="window.location.href = 'https://awssecworkshops.com/';" class="md-lang-dropbtn fa fa-home"></button>
                </div>
            </div>
        </div>
  
        <!-- Repository containing source -->
        
          <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__source">
              


  

<a href="https://github.com/aws-samples/aws-vulnerability-management-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/aws-vulnerability-management-workshop
  </div>
</a>
            </div>
          </div>
        
      </div>
    </nav>
  </header>
    
    <div class="md-container">
      
        
      
      
        

<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." title="Overview" class="md-tabs__link md-tabs__link--active">
        Overview
      </a>
    
  </li>

      
        
  <li class="md-tabs__item">
    
      <a href="../../module1/" title="Module 1: Asset Management" class="md-tabs__link md-tabs__link--active">
        Module 1: Asset Management
      </a>
    
  </li>

      
        
  <li class="md-tabs__item">
    
      <a href="../../module2/" title="Module 2: AMI Factory" class="md-tabs__link md-tabs__link--active">
        Module 2: AMI Factory
      </a>
    
  </li>

      
        
  <li class="md-tabs__item">
    
      <a href="../" title="Module 3: Vulnerability Assessment" class="md-tabs__link md-tabs__link--active">
        Module 3: Vulnerability Assessment
      </a>
    
  </li>

      
        
  <li class="md-tabs__item">
    
      <a href="../../module4/" title="Module 4: Fleet Management at Scale" class="md-tabs__link md-tabs__link--active">
        Module 4: Fleet Management at Scale
      </a>
    
  </li>

      
        
      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <!--
  Copyright (c) 2016-2019 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Main navigation -->
<nav class="md-nav md-nav--primary" data-md-level="0">

  <!-- Site title -->
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://vul-mgmt-program.awssecworkshops.com/"
        title="Build a Vulnerability Management Program Using AWS for AWS" class="md-nav__button md-logo">
      
        <img src="../../assets/images/aws_smile_logo.png" width="48" height="48" />
      
    </a>
    Vulnerability Management
  </label>

  <!-- Repository containing source -->
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/aws-samples/aws-vulnerability-management-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/aws-vulnerability-management-workshop
  </div>
</a>
    </div>
  

  <!-- Render item list -->
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../module1/" title="Module 1: Asset Management" class="md-nav__link">
      Module 1: Asset Management
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../module2/" title="Module 2: AMI Factory" class="md-nav__link">
      Module 2: AMI Factory
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../" title="Module 3: Vulnerability Assessment" class="md-nav__link">
      Module 3: Vulnerability Assessment
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../module4/" title="Module 4: Fleet Management at Scale" class="md-nav__link">
      Module 4: Fleet Management at Scale
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../contribute/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setting-up-and-running-amazon-inspector" title="Setting up and Running Amazon Inspector" class="md-nav__link">
    Setting up and Running Amazon Inspector
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#patching-your-windows-and-linux-instances-with-aws-ssm-patch-manager" title="Patching your Windows and Linux instances with AWS SSM Patch Manager" class="md-nav__link">
    Patching your Windows and Linux instances with AWS SSM Patch Manager
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-ec2-instance-role-for-ssm-and-tagging-under-a-patch-group" title="Creating EC2 instance Role for SSM and tagging under a Patch Group" class="md-nav__link">
    Creating EC2 instance Role for SSM and tagging under a Patch Group
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-an-iam-role-for-systems-manager" title="Create an IAM role for Systems Manager" class="md-nav__link">
    Create an IAM role for Systems Manager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attach-role-to-ec2-instances" title="Attach role to EC2 Instances" class="md-nav__link">
    Attach role to EC2 Instances
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-tags" title="Add Tags" class="md-nav__link">
    Add Tags
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-aws-systems-manager" title="Configure AWS Systems Manager" class="md-nav__link">
    Configure AWS Systems Manager
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-systems-manager-iam-role" title="Create the Systems Manager IAM Role" class="md-nav__link">
    Create the Systems Manager IAM Role
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#associate-a-systems-manager-patch-baseline-with-your-instance" title="Associate a Systems Manager patch baseline with your instance" class="md-nav__link">
    Associate a Systems Manager patch baseline with your instance
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#define-a-maintenance-window" title="Define a Maintenance Window" class="md-nav__link">
    Define a Maintenance Window
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#monitor-patch-compliance" title="Monitor Patch Compliance" class="md-nav__link">
    Monitor Patch Compliance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#automation-patching-your-windows-and-linux-instances-with-aws-ssm-patch-manager" title="Automation - Patching your Windows and Linux instances with AWS SSM Patch manager" class="md-nav__link">
    Automation - Patching your Windows and Linux instances with AWS SSM Patch manager
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#patch-anatomy" title="Patch Anatomy" class="md-nav__link">
    Patch Anatomy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#patch-workflow" title="Patch Workflow" class="md-nav__link">
    Patch Workflow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploy-cloudformation" title="Deploy CloudFormation" class="md-nav__link">
    Deploy CloudFormation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#takeaway" title="Takeaway" class="md-nav__link">
    Takeaway
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/aws-vulnerability-management-workshop/edit/master/docs/module3/indexv0.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="vulnerability-assessment-and-patch-manager-setup">Vulnerability Assessment and Patch Manager Setup</h1>
<p>In this section we are going to detect vulnerabilities on our live instances with <a href="https://aws.amazon.com/inspector/" target="_blank">Amazon Inspector</a>. Due to the duration of a comprehensive vulnerability assessment and the limitation of time for the workshop we will test for Security Group vulnerabilities with the Amazon Inspector Network Reachability rules package.</p>
<p>Additionally, we will show how to handle the execution of system patches utilizing approval workflows known as Patch Baselines.</p>
<h2 id="setting-up-and-running-amazon-inspector">Setting up and Running Amazon Inspector</h2>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can use the SSM run command to install the agent on your EC2 instances if they do not have the agent installed. <a href="https://docs.aws.amazon.com/inspector/latest/userguide/inspector_installing-uninstalling-agents.html#install-run-command" target="_blank">Here</a> is how you can do it.</p>
</div>
<ol>
<li>
<p>From the Management Console, go to the <a href="https://us-east-2.console.aws.amazon.com/inspector/home?region=us-east-2#/dashboard" target="_blank">Amazon Inspector</a> page. Click the Help Me Create an Assessment.</p>
</li>
<li>
<p>Click Advanced Setup</p>
</li>
<li>
<p>Define the assessment target</p>
<ul>
<li>Uncheck the <strong>All Instances</strong> checkbox, we will be creating an assessment based on tags. Tags are words or phrases that act as metadata for identifying and organizing your instances and other AWS resources. Every AWS tag consists of a key and value pair of your choice.</li>
<li>Use <strong>Owner</strong> as the Key.</li>
<li>
<p>Select your IAM user name as the Value. You can find this as one of the values assigned to your instances by looking through the tags associated with those instances.
<img alt="inspector Assessment Target" src="../images/inspectorAssessmentTarget.png" /></p>
</li>
<li>
<p>Using tags enables you to perform an assessment across different operating system types, specific applications and business units.</p>
</li>
</ul>
</li>
<li>
<p>Define an assessment template</p>
<ul>
<li>Select only the Network Reachability package.</li>
<li>Select 15 minute duration.</li>
<li>
<p>Set Assessment Schedule to 1 Days
<img alt="inspector assessment" src="../images/inspectorAssessmentTemplate.png" /></p>
</li>
<li>
<p>Click Next</p>
</li>
<li>On the next screen hit Create</li>
<li>You can now see your assessment template and configure it with an SNS topic for notifications and to trigger automated actions such as alerting and patching.</li>
</ul>
<p><img alt="Inspector Assessment Template Modification" src="../images/inspectorAssessmentSNS.png" /></p>
</li>
<li>
<p>Select your template and click Run</p>
</li>
<li>
<p>Click on Findings in the Navigation Pane and filter on Medium. Select one of the Medium Severity findings. You can find details as seen below in terms of Network Reachability
<img alt="Inspector Network Finding" src="../images/inspectorNetworkFinding.png" /></p>
</li>
</ol>
<h2 id="patching-your-windows-and-linux-instances-with-aws-ssm-patch-manager">Patching your Windows and Linux instances with AWS SSM Patch Manager</h2>
<p>AWS Systems Manager Patch Manager automates the process of patching managed instances with both security related and other types of updates. You can use Patch Manager to apply patches for both operating systems and applications. (On Windows Server, application support is limited to updates for Microsoft applications.) You can patch fleets of EC2 instances or your on-premises servers and virtual machines (VMs) by operating system type. This includes supported versions of Windows Server, Ubuntu Server, Red Hat Enterprise Linux (RHEL), SUSE Linux Enterprise Server (SLES), CentOS, Amazon Linux, and Amazon Linux 2. You can scan instances to see only a report of missing patches, or you can scan and automatically install all missing patches.</p>
<p><img alt="SSM Patch Manager Workflow" src="../images/ssm-patch-manager.PNG" /></p>
<p>Patch Manager uses patch baselines, which include rules for auto-approving patches within days of their release, as well as a list of approved and rejected patches. You can install patches on a regular basis by scheduling patching to run as a Systems Manager maintenance window task. You can also install patches individually or to large groups of instances by using Amazon EC2 tags. (Tags are keys that help identify and sort your resources within your organization.) You can add tags to your patch baselines themselves when you create or update them.</p>
<h2 id="creating-ec2-instance-role-for-ssm-and-tagging-under-a-patch-group">Creating EC2 instance Role for SSM and tagging under a Patch Group</h2>
<h3 id="create-an-iam-role-for-systems-manager">Create an IAM role for Systems Manager</h3>
<p>Before launching an Amazon EC2 instance, we recommend that your EC2 instances are associated with an instance profile with the <strong>AmazonEC2RoleforSSM</strong> AWS Managed Policy attached.</p>
<ol>
<li>
<p>Sign in to the IAM console and choose Roles in the navigation pane. Choose Create new role.
<img alt="Step 1 EC2" src="../images/instance-role-ssm-step1.png" /></p>
</li>
<li>
<p>In the role-creation workflow, choose AWS service &gt; EC2 &gt; EC2 to create a role for an EC2 instance.
<img alt="Step 2 EC2" src="../images/instance-role-ssm-step2.png" /></p>
</li>
<li>
<p>Choose the AmazonEC2RoleforSSM policy to attach it to the new role you are creating.
<img alt="Step 3 EC2" src="../images/instance-role-ssm-step3.png" /></p>
</li>
<li>
<p>You can leave the tags blank for this role.</p>
</li>
<li>
<p>Give the role a meaningful name (I chose EC2SSM) and description, and choose <strong>Create role</strong>.
<img alt="Step 4 EC2" src="../images/instance-role-ssm-step4.png" /></p>
</li>
</ol>
<h3 id="attach-role-to-ec2-instances">Attach role to EC2 Instances</h3>
<ol>
<li>Navigate the EC2 console and select one of your instances from Module 1.</li>
<li>Select that instance and then click on the <strong>Actions</strong> drop down</li>
<li>Select <strong>Instance Settings</strong> and then Attach/Replace IAM Role</li>
<li>Select the IAM Role that you just created and hit <strong>Apply</strong></li>
</ol>
<h3 id="add-tags">Add Tags</h3>
<p>The final step of configuring your EC2 instances is to add tags to the instances you just attached the EC2SSM role to. You will use these tags to configure Systems Manager later in this module. For this example I add a tag with a key of <em>Patch Group</em> and value of <em>Windows Servers</em>. I could have other groups of EC2 instances that I treat differently by having the same tag key but a different tag value. For example, I might have a collection of other servers with the Patch Group tag key with a value of IIS Servers.</p>
<p><img alt="Step 5 EC2" src="../images/instance-role-ssm-step5.png" /></p>
<h2 id="configure-aws-systems-manager">Configure AWS Systems Manager</h2>
<p>In this section, I show you how to use Systems Manager to apply operating system patches to your EC2 instances, and how to manage patch compliance.</p>
<p>To start, I will provide some background information about Systems Manager. Then, I will cover how to:</p>
<ul>
<li>Create the Systems Manager IAM role so that Systems Manager is able to perform patch operations.</li>
<li>Associate a Systems Manager patch baseline with your instance to define which patches Systems Manager should apply.</li>
<li>Define a maintenance window to make sure Systems Manager patches your instance when you tell it to.</li>
<li>Monitor patch compliance to verify the patch state of your instances.</li>
</ul>
<p>AWS Systems Manager is an AWS service that you can use to view and control your infrastructure on AWS. Systems Manager helps you maintain security and compliance by scanning your managed instances and reporting on (or taking corrective action on) any policy violations it detects. In this section, we use Systems Manager for two purposes: to run remote commands and apply operating system patches.</p>
<p>There are two prerequisites to use Systems Manager to apply operating system patches. First, you must attach the IAM role you created in the previous section, EC2SSM, to your EC2 instance. Second, you must install the Systems Manager agent on your EC2 instance. The Systems Manager agent comes pre-installed on recent Linux and Windows AMIs published by AWS.</p>
<p>To make sure your EC2 instance receives operating system patches from Systems Manager, you will use the default patch baseline provided and maintained by AWS, and you will define a maintenance window. For the maintenance window to be able to run any tasks, you also must create a new role for Systems Manager. Earlier we created the <em>EC2SSM</em> role with the <em>AmazonEC2RoleforSSM</em> policy, which allowed the Systems Manager agent on our instance to communicate with the Systems Manager service. Here we need a new role with the policy <em>AmazonSSMMaintenanceWindowRole</em> to make sure the Systems Manager service is able to execute commands on our instance.</p>
<h3 id="create-the-systems-manager-iam-role">Create the Systems Manager IAM Role</h3>
<p>To create the new IAM role for Systems Manager, follow the same procedure as in the previous section, but in Step 3, choose the <strong>AmazonSSMMaintenanceWindowRole</strong> policy.
<img alt="SSM Part 1" src="../images/ssm-role-step1.png" /></p>
<p>Finish the wizard and give your new role a recognizable name. For example, I named my role MaintenanceWindowRole</p>
<p>By default, only EC2 instances can assume this new role. You must update the trust policy to enable Systems Manager to assume this role.</p>
<p>To update the trust policy associated with this new role:</p>
<ol>
<li>
<p>Navigate to the IAM console and choose <strong>Roles</strong> in the navigation pane.</p>
</li>
<li>
<p>Choose <strong>MaintenanceWindowRole</strong> and choose the <strong>Trust relationships</strong> tab. Then choose <strong>Edit trust relationship</strong>.
<img alt="SSM Step 2" src="../images/ssm-role-step2.png" /></p>
</li>
<li>
<p>Update the policy document by copying the following policy and pasting it in the Policy Document box. As you can see, I have added the <a href="https://aws.amazon.com/systems-manager/" target="_blank">SSM</a> service to the list of allowed Principals that can assume this role. Choose Update Trust Policy.</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><span class="err">{</span>
   <span class="ss">&quot;Version&quot;</span><span class="p">:</span><span class="ss">&quot;2012-10-17&quot;</span><span class="p">,</span>
   <span class="ss">&quot;Statement&quot;</span><span class="p">:[</span>
      <span class="err">{</span>
         <span class="ss">&quot;Sid&quot;</span><span class="p">:</span><span class="ss">&quot;&quot;</span><span class="p">,</span>
         <span class="ss">&quot;Effect&quot;</span><span class="p">:</span><span class="ss">&quot;Allow&quot;</span><span class="p">,</span>
         <span class="ss">&quot;Principal&quot;</span><span class="p">:</span><span class="err">{</span>
            <span class="ss">&quot;Service&quot;</span><span class="p">:[</span>
               <span class="ss">&quot;ec2.amazonaws.com&quot;</span><span class="p">,</span>
               <span class="ss">&quot;ssm.amazonaws.com&quot;</span>
           <span class="p">]</span>
         <span class="err">}</span><span class="p">,</span>
         <span class="ss">&quot;Action&quot;</span><span class="p">:</span><span class="ss">&quot;sts:AssumeRole&quot;</span>
      <span class="err">}</span>
   <span class="p">]</span>
<span class="err">}</span>
</pre></div>


<h3 id="associate-a-systems-manager-patch-baseline-with-your-instance">Associate a Systems Manager patch baseline with your instance</h3>
<p>Next, you are going to associate a Systems Manager patch baseline with your EC2 instance. A patch baseline defines which patches Systems Manager should apply. You will use the default patch baseline that AWS manages and maintains. Before you can associate the patch baseline with your instance, you must determine if Systems Manager recognizes your EC2 instance.</p>
<p>Navigate to the Systems Manager console, select <strong>Managed Instances</strong> under the <strong>Instances &amp; Nodes</strong> dropdown. Your new EC2 instance should be available there
<img alt="SSM Step 3" src="../images/ssm-role-step3.png" /></p>
<p>Now that you have confirmed that Systems Manager can manage your EC2 instance, it is time to associate the AWS maintained patch baseline with your EC2 instance:</p>
<ol>
<li>
<p>Choose <strong>Patch Manager</strong> under <strong>Instances &amp; Nodes</strong> in the sidebar of the AWS Systems Manager Console.</p>
</li>
<li>
<p>Choose <strong>View predefined patch baselines</strong> as highlighted in the following screenshot.
<img alt="SSM Step 4" src="../images/ssm-role-step4.png" /></p>
</li>
<li>
<p>Select the <em>AWS-DefaultPatchBasline</em> and then choose <strong>Modify Patch Groups</strong> in the <strong>Actions</strong> drop-down.
<img alt="SSM Step 4.5" src="../images/ssm-role-step45.png" /></p>
</li>
<li>
<p>In the Patch group box, enter the same value you entered under the Patch Group tag of your EC2 instance. In this example, the value I enter is Windows Servers. Click the <strong>Add</strong> button next to the patch group and click <strong>Close</strong>.
<img alt="SSM Step 5" src="../images/ssm-role-step5.png" /></p>
</li>
</ol>
<h3 id="define-a-maintenance-window">Define a Maintenance Window</h3>
<p>Now that you have successfully set up a role and have associated a patch baseline with your EC2 instance, you will define a maintenance window so that you can control when your EC2 instances should receive patches. By creating multiple maintenance windows and assigning them to different patch groups, you can make sure your EC2 instances do not all reboot at the same time. The <em>Patch Group</em> resource tag you defined earlier will determine to which patch group an instance belongs.</p>
<ol>
<li>
<p>Navigate to the Systems Manager console, in the sidebar under <strong>Actions &amp; Change</strong> choose <strong>Maintenance Windows</strong>. Choose Create a Maintenance Window.
<img alt="Maint Wind Step1" src="../images/maint-window-step1.png" /></p>
</li>
<li>
<p>Select the Cron schedule builder to define the schedule for the maintenance window. In the example in the following screenshot, the maintenance window will start every Saturday at 10:00 P.M. UTC.</p>
</li>
<li>
<p>To specify when your maintenance window will end, specify the duration. In this example, the four-hour maintenance window will end on the following Sunday morning at 2:00 A.M. UTC.</p>
</li>
<li>
<p>Lastly uncheck the <em>Allow unregistered targets</em> box.
<img alt="Maint Wind Step2" src="../images/maint-window-step2.png" /></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Systems manager completes all tasks that are in process, even if the maintenance window ends. In this example, we are choosing to prevent new tasks from starting within one hour of the end of my maintenance window because we estimated that patch operations might take longer than one hour to complete.</p>
</div>
</li>
<li>
<p>Confirm the creation of the maintenance window by choosing <strong>Create maintenance</strong> button.</p>
</li>
<li>
<p>You must register the EC2 instances to the maintenance window so that Systems Manager knows which EC2 instance it should patch. To do so, choose <strong>Register targets</strong> by selecting the option under <strong>Actions</strong> after you select your new maintenance window. You can register your targets by using the same Patch Group tag you used before to associate the EC2 instance with the AWS-provided patch baseline.
<img alt="Maint Wind Step3" src="../images/maint-window-step3.png" /></p>
</li>
<li>
<p>Assign a task to the maintenance window that will install the operating system patches on your EC2 instance:</p>
<ul>
<li>Open <strong>Maintenance Windows</strong> in the Systems Manager console, select your previously created maintenance window and choose <strong>Register run command</strong> task from the <strong>Actions</strong> drop-down.</li>
<li>For <strong>Maintenance window task details</strong>:<ul>
<li>Give the Maintenance Window an optional Name and Description</li>
</ul>
</li>
<li>For <strong>Comand document</strong>:<ul>
<li>Search for the <em>AWS-RunPatchBaseline</em> document from the list of available documents.</li>
</ul>
</li>
<li>For <strong>Targets</strong>:<ul>
<li>Select your previously created <em>Window Target ID</em></li>
</ul>
</li>
<li>
<p>For <strong>Rate control</strong>:</p>
<ul>
<li>Specify your Concurrency and Error threshold</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you have a large number of EC2 instances and want to patch all EC2 instances within the defined time, make sure this number is not too low. For example, if you have 1,000 EC2 instances, a maintenance window of 4 hours, and 2 hours’ time for patching, make this number at least 500.</p>
</div>
</li>
<li>
<p>For <strong>IAM service role</strong></p>
<ul>
<li>Choose the role you created previously (called <em>MaintenanceWindowRole</em>).</li>
</ul>
</li>
<li>Leave <strong>Output options</strong> and <strong>SNS notifications</strong> unchecked</li>
<li>For <strong>Parameters</strong>:<ul>
<li>For <strong>Operation</strong>, choose Install to make sure to install the patches.</li>
<li>Leave the rest of the Parameters to default or no values</li>
</ul>
</li>
<li>Click <strong>Register Run command task</strong></li>
</ul>
</li>
</ol>
<p>Now, you must wait for the maintenance window to run at least once according to the schedule you defined earlier. Note that if you don’t want to wait, you can adjust the schedule to run sooner by choosing Edit maintenance window on the Maintenance Windows page of Systems Manager. If your maintenance window has passed, you can check the status of any maintenance tasks Systems Manager has performed on the Maintenance Windows page of Systems Manager by selecting your maintenance window.</p>
<h3 id="monitor-patch-compliance">Monitor Patch Compliance</h3>
<p>You also can see the overall patch compliance of all EC2 instances that are part of defined patch groups by choosing <strong>Compliance</strong> under the <strong>Instances &amp; Nodes</strong> tab in the Systems Manager Console. You can filter by Patch Group to see how many EC2 instances within the selected patch group are up to date, how many EC2 instances are missing updates, and how many EC2 instances are in an error state.
<img alt="SSM Step 12" src="../images/monitor-compliance.png" /></p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>If you check the Compliance tab in the Systems Manager console during this lab you may not see any results due to the Task in your Maintenance Window not running yet.</p>
</div>
<h2 id="automation-patching-your-windows-and-linux-instances-with-aws-ssm-patch-manager">Automation - Patching your Windows and Linux instances with AWS SSM Patch manager</h2>
<p>AWS SSM Patch Manager enables automation of the process of patching managed instances. Instances can be scanned to see a report of missing patches, or automatically install all missing patches. Patch Manager uses patch baselines that include rules for auto-approving patches within days of their release, as well as a list of approved and rejected patches.</p>
<p>Patches can be installed on a regular basis by scheduling patching to run as a Systems Manager Maintenance Window task. Patches can be at any scale from individual instances to large groups of instances by using Amazon EC2 tags.</p>
<p>To use Patch Manager, the following tasks must be completed.</p>
<ol>
<li>Verify that the default patch baselines meet your needs, or create patch baselines that define a standard set of patches for your instances.</li>
<li>Organize instances into patch groups by using Amazon EC2 tags.</li>
<li>Schedule patching by using a Maintenance Window that defines which instances to patch and when to patch them.</li>
<li>Monitor patching to verify compliance and investigate failures.</li>
</ol>
<h3 id="patch-anatomy">Patch Anatomy</h3>
<p>The Patch Anatomy automation can be seen below:</p>
<p><img alt="Patch Mngr Workflow" src="../images/patchmanagerworkflow.png" /></p>
<p>Select the patches you want to deploy and control timing for patch roll-outs and instance reboots. Define auto-approval rules for patches and have the ability to black-list or white-list specific patches. Schedule the automatic roll out through maintenance windows</p>
<h3 id="patch-workflow">Patch Workflow</h3>
<p>We will deploy a CloudFormation that will create the following Patch management Workflow</p>
<p><img alt="Patch Mngr Workflow 2" src="../images/patchmanagerworkflow2.png" /></p>
<ol>
<li>
<p>Create necessary roles</p>
<ul>
<li>The roles to enable the EC2 instance communicate with SSM and SSM to communicate with the EC2 instance to be created.</li>
</ul>
</li>
<li>
<p>Create EC2 fleet with Patch Groups</p>
<ul>
<li>Create EC2 instances with the instance profile created above and attach the ‘Patch Group’ tag to the associated instances.</li>
</ul>
</li>
<li>
<p>Create patch baseline</p>
<ul>
<li>A patch baseline defines which patches are approved for installation on your instances. You can specify approved or rejected patches one by one.</li>
<li>Auto-approval rules specify that certain types of updates (for example, critical updates) should be automatically approved. The rejected list overrides both the rules and the approve list.</li>
<li>
<p>Create patch groups</p>
</li>
<li>
<p>Patch groups can be defined by the type of operating system, compliance level and classification of the patch.</p>
</li>
</ul>
</li>
<li>
<p>Create a maintenance window</p>
<ul>
<li>This is the scheduler that maps through the list of registered targets and the corresponding tasks to be executed.</li>
<li>The task registry has the document to be executed and the priority where multiple tasks are involved and attach the execution role created earlier.</li>
</ul>
</li>
</ol>
<h3 id="deploy-cloudformation">Deploy CloudFormation</h3>
<details class="info"><summary>Click here if you're running this individually in your own AWS Account</summary><p>Launch the CloudFormation stack below to setup the SSM Patch Management Script:</p>
<table>
<thead>
<tr>
<th>Region</th>
<th>Deploy</th>
</tr>
</thead>
<tbody>
<tr>
<td>US East 2 (Ohio)</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/new?stackName=Vuln-Mngmt-Wksp-Module-3-SSM-Patch-Management&templateURL=https://sec337-reinvent.s3.us-east-2.amazonaws.com/Templates/SSM-Automation-Setup.template" target="_blank"><img alt="Deploy in us-east-2" src="../images/deploy-to-aws.png" /></a></td>
</tr>
</tbody>
</table>
<ol>
<li>
<p>Click the <strong>Deploy to AWS</strong> button above (right click and open in a new tab).  This will automatically take you to the console to run the template.  </p>
</li>
<li>
<p>Click <strong>Next</strong> on the <strong>Specify Template</strong> section.</p>
</li>
<li>
<p>On the <strong>Specify Details</strong> step click <strong>Next</strong>.</p>
</li>
<li>
<p>Click <strong>Next</strong> on the <strong>Options</strong> section.</p>
</li>
<li>
<p>Finally, acknowledge that the template will create IAM roles under <strong>Capabilities</strong> and click <strong>Create</strong>.</p>
</li>
</ol>
<p>This will bring you back to the CloudFormation console. You can refresh the page to see the stack starting to create. Before moving on, make sure the stack is in a <strong>CREATE_COMPLETE</strong>.</p>
</details>
<p><strong>Expected Outcome</strong></p>
<p>The instances which are scanned and ready to be patched using the Patch Manager will be visible under the EC2 – SSM – Managed Instances.</p>
<p>The compliance report can be fetched with filter by tag values (‘Windows2012-PatchGroup’ for Windows and ‘Amz_Linux_Patch_Group’ for Amazon Linux) or by instance id. The data will display the instances that are compliant and/or instances that need patching. This provides complete audit capability on your environment.</p>
<h3 id="takeaway">Takeaway</h3>
<p>In this module, you have set everything up for patch management on your instance. Now you know how to patch your EC2 instance in a controlled manner and how to check if your EC2 instance is compliant with the patch baseline you have defined. Of course, I recommend that you apply these steps to all EC2 instances you manage.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://awssecworkshops.com" class="md-footer-social__link fa fa-home"></a>
    
      <a href="https://aws.amazon.com/security/" class="md-footer-social__link fa fa-shield"></a>
    
      <a href="https://twitter.com/awssecurityinfo?lang=en" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://aws.amazon.com/blogs/security/" class="md-footer-social__link fa fa-rss"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>