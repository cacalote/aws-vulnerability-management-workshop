



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="This hands-on workshop is where you will learn about a number of AWS services involved with threat detection and response as we walk through real-world threat scenarios. Learn about the threat detection capabilities of Amazon GuardDuty, Amazon Macie and AWS Security Hub and the available response options. For each hands-on scenario, we review methods to detect and respond to threats using the following services: AWS CloudTrail, Amazon VPC flow logs, Amazon CloudWatch Events, Amazon Macie, AWS Lambda, Amazon Inspector, Amazon GuardDuty and Amazon Security Hub.">
      
      
        <link rel="canonical" href="https://vul-mgmt-program.awssecworkshops.com/module4/">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Module 4 - Build a Vulnerability Management Program Using AWS for AWS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.0284f74d.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#ec2-fleet-management-at-scale" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">
  
        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>
  
        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>
  
        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Build a Vulnerability Management Program Using AWS for AWS
                </span>
                <span class="md-header-nav__topic">
                  Module 4
                </span>
              
            
          </div>
        </div>
        
        
        <!-- Button to open search dialogue -->
        <!--
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>
  
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>

         -->
         
         <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-flex__ellipsis md-header-nav__lang">
                <div>
                    <button onclick="window.location.href = 'https://awssecworkshops.com/';" class="md-lang-dropbtn fa fa-home"></button>
                </div>
            </div>
        </div>
  
        <!-- Repository containing source -->
        
          <div class="md-flex__cell md-flex__cell--shrink">
            <div class="md-header-nav__source">
              


  

<a href="https://github.com/aws-samples/aws-vulnerability-management-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/aws-vulnerability-management-workshop
  </div>
</a>
            </div>
          </div>
        
      </div>
    </nav>
  </header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href=".." title="Overview" class="md-tabs__link">
        Overview
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../module1/" title="Asset Management and Tagging" class="md-tabs__link">
          Asset Management and Tagging
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../module2/" title="AMI Factory" class="md-tabs__link">
          AMI Factory
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../module3/" title="Vulnerability Assessment and Patch Manager Setup" class="md-tabs__link">
          Vulnerability Assessment and Patch Manager Setup
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="./" title="EC2 Fleet Management at Scale" class="md-tabs__link md-tabs__link--active">
          EC2 Fleet Management at Scale
        </a>
      
    </li>
  

      
        
      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <!--
  Copyright (c) 2016-2019 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Main navigation -->
<nav class="md-nav md-nav--primary" data-md-level="0">

  <!-- Site title -->
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://vul-mgmt-program.awssecworkshops.com/"
        title="Build a Vulnerability Management Program Using AWS for AWS" class="md-nav__button md-logo">
      
        <img src="../assets/images/aws_smile_logo.png" width="48" height="48" />
      
    </a>
    Build a Vulnerability Management Program
  </label>

  <!-- Repository containing source -->
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/aws-samples/aws-vulnerability-management-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    aws-samples/aws-vulnerability-management-workshop
  </div>
</a>
    </div>
  

  <!-- Render item list -->
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Asset Management and Tagging
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Asset Management and Tagging
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../module1/" title="Module 1" class="md-nav__link">
      Module 1
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      AMI Factory
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        AMI Factory
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../module2/" title="Module 2" class="md-nav__link">
      Module 2
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Vulnerability Assessment and Patch Manager Setup
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Vulnerability Assessment and Patch Manager Setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../module3/" title="Module 3" class="md-nav__link">
      Module 3
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      EC2 Fleet Management at Scale
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        EC2 Fleet Management at Scale
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Module 4
      </label>
    
    <a href="./" title="Module 4" class="md-nav__link md-nav__link--active">
      Module 4
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" title="Overview" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture" title="Architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution-components" title="Solution Components" class="md-nav__link">
    Solution Components
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#systems-manager-associations" title="Systems Manager Associations" class="md-nav__link">
    Systems Manager Associations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maintenance-window" title="Maintenance Window" class="md-nav__link">
    Maintenance Window
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amazon-inspector-rules-packages" title="Amazon Inspector Rules Packages" class="md-nav__link">
    Amazon Inspector Rules Packages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#launch-the-template" title="Launch the Template" class="md-nav__link">
    Launch the Template
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercises" title="Exercises" class="md-nav__link">
    Exercises
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-ssm-session-manager-walkthrough" title="AWS SSM Session Manager Walkthrough" class="md-nav__link">
    AWS SSM Session Manager Walkthrough
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analyze-your-fleet-with-insights" title="Analyze your fleet with Insights" class="md-nav__link">
    Analyze your fleet with Insights
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contribute/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" title="Overview" class="md-nav__link">
    Overview
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture" title="Architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution-components" title="Solution Components" class="md-nav__link">
    Solution Components
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#systems-manager-associations" title="Systems Manager Associations" class="md-nav__link">
    Systems Manager Associations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maintenance-window" title="Maintenance Window" class="md-nav__link">
    Maintenance Window
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amazon-inspector-rules-packages" title="Amazon Inspector Rules Packages" class="md-nav__link">
    Amazon Inspector Rules Packages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#launch-the-template" title="Launch the Template" class="md-nav__link">
    Launch the Template
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exercises" title="Exercises" class="md-nav__link">
    Exercises
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-ssm-session-manager-walkthrough" title="AWS SSM Session Manager Walkthrough" class="md-nav__link">
    AWS SSM Session Manager Walkthrough
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analyze-your-fleet-with-insights" title="Analyze your fleet with Insights" class="md-nav__link">
    Analyze your fleet with Insights
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/aws-vulnerability-management-workshop/edit/master/docs/module4/index.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="ec2-fleet-management-at-scale">EC2 Fleet Management at Scale</h1>
<p>In this module we will put all our knowledge together from the last 3 modules to manage our EC2 Server Fleet at Scale. This implementation guide discusses architectural considerations and configuration steps for deploying the Server Fleet Management at Scale solution on the Amazon Web Services (AWS) Cloud. It includes links to an AWS CloudFormation template that launches, configures, and runs the AWS services required to deploy this solution using AWS best practices for security and availability.</p>
<h2 id="overview">Overview</h2>
<p>Amazon Web Services (AWS) customers who own a fleet of servers are sometimes unsure of how to best automate their fleet management for operational efficiency and maintenance. AWS Systems Manager provides a unified user interface so customers can view operational data from multiple AWS services, and allows customers to automate operational tasks across their AWS resources. With Systems Manager, customers can maintain a consistent configuration of their Amazon Elastic Compute Cloud (Amazon EC2) or on-premises instances. They can also automate maintenance and deployment tasks, or automatically apply patches, updates, and configuration changes across any resource group.</p>
<p>To help customers more easily leverage the capabilities of Systems Manager, AWS offers the Server Fleet Management at Scale solution. This solution combines Systems Manager with Amazon Inspector, an automated security assessment service, to help simplify software inventory management, OS patch compliance, and security vulnerability assessments on managed instances. The solution is easy-to-deploy, and automatically provisions the services necessary to automate server fleet management.</p>
<div class="admonition info">
<p class="admonition-title">Cost</p>
<p>You are responsible for the cost of the AWS services used while running this reference deployment. As of the date of publication, the cost for running this solution with default settings in the US East (N. Virginia) Region for 100 Amazon EC2 instances, and daily Amazon Inspector assessments is approximately $562.50 per month. This pricing does not include variable charges incurred from Amazon EC2 instances, Amazon Simple Storage Service (Amazon S3), AWS Lambda, or Amazon CloudWatch.
Prices are subject to change. For full details, see the pricing webpage for each AWS service you will be using in this solution.</p>
</div>
<h3 id="prerequisites">Prerequisites</h3>
<ol>
<li>
<p>Terminate Instances created in earlier modules</p>
</li>
<li>
<p>Delete the SSM Patch Management CloudFormation stack from Module 3</p>
</li>
</ol>
<h2 id="architecture">Architecture</h2>
<p><img alt="Fleet Management Arch" src="images/server-fleet-management-architecture.png" /></p>
<p>The AWS CloudFormation template deploys AWS Systems Manager, Amazon Inspector, an Amazon Simple Storage Service (Amazon S3) bucket, an AWS Key Management Service (AWS KMS) key, an AWS Identity and Access Management (IAM) role, an Amazon CloudWatch event, an AWS Lambda function, and an Amazon Simple Notification Service (Amazon SNS) topic.</p>
<p>Systems Manager specifies patch compliance thresholds, defines the schedule for when patching tasks should be run, and defines the Systems Manager associations used to periodically ensure that servers remain in compliance with established configurations. Systems Manager artifacts, including patching and server execution histories and inventories, are stored in the Amazon S3 bucket and encrypted with an AWS KMS key.</p>
<p>A CloudWatch event triggers Amazon Inspector to run daily security assessments on your fleet of Amazon Elastic Compute Cloud (Amazon EC2) instances. Amazon Inspector defines the rules packages for assessments and identifies the target Amazon EC2 instances for assessment runs. When the assessment is complete, Amazon Inspector publishes a message to an Amazon SNS topic that has two subscribers; an AWS Lambda function, and the provided email address. The function then queries Amazon Inspector for the agent IDs of the agents within the assessment run, and sends a message for each agent ID to a second Amazon SNS topic. A second Lambda function receives a notification for each agent ID and queries Amazon Inspector for the findings for each agent, sorts them by vulnerabilities, and updates the Systems Manager Inventory data for the instance under management. Note that the maximum number of agents that can be included in the assessment target of an assessment run is 500.</p>
<h2 id="solution-components">Solution Components</h2>
<h3 id="systems-manager-associations">Systems Manager Associations</h3>
<p>The <em>ManageInspectorAgent</em> association runs weekly to ensure that the Inspector agent is installed on the targeted managed instances.</p>
<p>The <em>GatherSoftwareInventory</em> association runs daily to gather the software inventory of the targeted managed instances. You can view a list of the managed instance’s application in the Managed Instance Console <strong>Inventory</strong> tab.</p>
<h3 id="maintenance-window">Maintenance Window</h3>
<p>A maintenance window allows you to define tasks that will be run against a set of instances on a given schedule. This gives you flexibility and control for how you perform routine tasks. The solution’s created maintenance window is scheduled to run weekly in a two-hour window, contains a Run Command task that uses the document <em>AWS-RunPatchBaseline</em> to perform patching, and updates the targets defined by the Patch Group tag key and the <em>Environment</em> value supplied in the <strong>Managed Instances Tag Value</strong> parameter.</p>
<h3 id="amazon-inspector-rules-packages">Amazon Inspector Rules Packages</h3>
<p>Amazon Inspector compares the behavior and the security configuration of the assessment targets to selected security rules packages. Currently, this solution uses the following rules packages:</p>
<ul>
<li><a href="https://docs.aws.amazon.com/inspector/latest/userguide/inspector_cves.html” target="_blank">Common Vulnerabilities and Exposures</a></li>
<li><a href="https://docs.aws.amazon.com/inspector/latest/userguide/inspector_security-best-practices.html”target="_blank">Security Best Practices</a></li>
<li><a href="https://docs.aws.amazon.com/inspector/latest/userguide/inspector_runtime-behavior-analysis.html”target="_blank">Runtime Behavior Analysis</a></li>
</ul>
<h3 id="launch-the-template">Launch the Template</h3>
<p>Click below to deploy the <a href="https://aws.amazon.com/solutions/server-fleet-management-at-scale/“ target="_blank">Server Fleet Management At Scale</a> CloudFormation template. The default configuration deploys AWS Systems Manager, Amazon Inspector, an Amazon Simple Storage Service (Amazon S3) bucket, an AWS Key Management Service (AWS KMS) key, an AWS Identity and Access Management (IAM) role, an Amazon CloudWatch event, an AWS Lambda function, and an Amazon Simple Notification Service (Amazon SNS) topic, but you can also customize the template based on your specific needs.</p>
<details class="info"><summary>Click here if you're running this individually in your own AWS Account</summary><p>Launch the CloudFormation stack below to setup the Server Fleet Management At Scale Solution:</p>
<table>
<thead>
<tr>
<th>Region</th>
<th>Deploy</th>
</tr>
</thead>
<tbody>
<tr>
<td>US East 2 (Ohio)</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/new?stackName=Server-Fleet-Mngmt-At-Scale&templateURL=https://s3.amazonaws.com/solutions-reference/server-fleet-management-at-scale/latest/server-fleet-management-at-scale.template" target="_blank"><img alt="Deploy in us-east-2" src="images/deploy-to-aws.png" /></a></td>
</tr>
</tbody>
</table>
<ol>
<li>
<p>Click the <strong>Deploy to AWS</strong> button above (right click and open in a new tab).  This will automatically take you to the console to run the template.  </p>
</li>
<li>
<p>Click <strong>Next</strong> on the <strong>Specify Template</strong> section.</p>
</li>
<li>
<p>On the <strong>Specify Details</strong> step click <strong>Next</strong>. </p>
</li>
<li>
<p>Click <strong>Next</strong> on the <strong>Options</strong> section.</p>
</li>
<li>Finally, acknowledge that the template will create IAM roles under <strong>Capabilities</strong> and click <strong>Create</strong>.</li>
</ol>
<p>This will bring you back to the CloudFormation console. You can refresh the page to see the stack starting to create. Before moving on, make sure the stack is in a <strong>CREATE_COMPLETE</strong>.</p>
</details>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you delete the solution stack, all of the resources created by the AWS CloudFormation template will be deleted, except the Resource Sync Amazon S3 bucket. You must manually delete the bucket.</p>
</div>
<h2 id="exercises">Exercises</h2>
<h3 id="aws-ssm-session-manager-walkthrough">AWS SSM Session Manager Walkthrough</h3>
<p>As customers on AWS move towards a model of deploying IT resources via Infrastructure-as-code, there is still a need for maintaining legacy applications by the old model of limited automation and manual tasks. IT administrators still need shell-level access to their servers on occasion. They might need to kill runaway processes, consult server logs, fine-tune configurations, or install temporary patches, all while maintaining a strong security profile. They want to avoid the hassle that comes with running Bastion hosts and the risks that arise when opening up inbound SSH ports on the instances.</p>
<p>AWS already addressed some of the need for shell-level access with the AWS Systems Manager Run Command. This AWS facility gives administrators secure access to EC2 instances. It allows them to create command documents and run them on any desired set of EC2 instances, with support for both Linux and Microsoft Windows. The commands are run asynchronously, with output captured for review.</p>
<p>Session Manager makes the AWS Systems Manager even more powerful. You can now use a browser-based interactive shell and a command-line interface (CLI) to manage your Windows and Linux instances. Here’s what you get:</p>
<p><strong>Secure Access</strong> – You don’t have to manually set up user accounts, passwords, or SSH keys on the instances and you don’t have to open up any inbound ports. Session Manager communicates with the instances via the SSM Agent across an encrypted tunnel that originates on the instance, and does not require a bastion host.</p>
<p><strong>Access Control</strong> – You use IAM policies and users to control access to your instances, and don’t need to distribute SSH keys. You can limit access to a desired time/maintenance window by using IAM’s Date Condition Operators.</p>
<p><strong>Auditability</strong> – Commands and responses can be logged to Amazon CloudWatch and to an S3 bucket. You can arrange to receive an SNS notification when a new session is started.</p>
<p><strong>Interactivity</strong> – Commands are executed synchronously in a full interactive bash (Linux) or PowerShell (Windows) environment</p>
<p><strong>Programming and Scripting</strong> – In addition to the console access that I will show you in a moment, you can also initiate sessions from the command line (aws ssm ...) or via the Session Manager APIs.</p>
<p>The SSM Agent running on the EC2 instances must be able to connect to Session Manager’s public endpoint. You can also set up a PrivateLink connection to allow instances running in private VPCs (without Internet access or a public IP address) to connect to Session Manager.</p>
<p><strong>Session Manager in Action</strong></p>
<ol>
<li>
<p>Choose Start session</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>In the Target instances list, choose the radio button to the left of the instance you want to connect to. In order to use Session Manager to access your EC2 instances, the instances must be running the latest version (2.3.12 or above) of the SSM Agent. The instance profile for the instances must reference a policy that allows access to the appropriate services; you can create your own or use AmazonEC2RoleForSSM. You have walked through this exercise in Module 3 and the sample fleet deployed in this exercise have been launched with the necessary instance profile.</p>
</div>
</li>
<li>
<p>Select the Linux AMI
    <img alt="Start Session Linux" src="images/sessionmanagerstartsession.png" /></p>
</li>
<li>The session opens up immediately:
    <img alt="Session Linux Launch" src="images/sessionlinuxlaunch.png" /></li>
<li>Similarly, with the Windows instance, you can see a session below:
    <img alt="Windows Session" src="images/sessionmanagerwindows.png" /></li>
</ol>
<p><strong>What is a Session?</strong></p>
<p>A session is a connection made to an instance using Session Manager. Sessions are based on a secure bi-directional communication channel between the client (you) and the remote managed instance that streams inputs and outputs for commands. Traffic between a client and a managed instance is encrypted using TLS 1.2, and requests to create the connection are signed using Sigv4. This two-way communication enables interactive bash and PowerShell access to instances. When you start a session, AWS SSM Session Manager initiates a connection to a target (for example, an instance) for a Session Manager session. In the background, a WebSocket connection is open for sending input and receiving outputs.</p>
<h3 id="analyze-your-fleet-with-insights">Analyze your fleet with Insights</h3>
<p><strong>Enable AWS Config Rules</strong></p>
<ol>
<li>
<p>Sign in to the AWS Management Console and open <a href="https://us-east-2.console.aws.amazon.com/config/home?region=us-east-2#/dashboard“target="_blank">AWS Config</a>.</p>
</li>
<li>
<p>In the left navigation, choose Rules.</p>
</li>
<li>
<p>On the Rules page, choose Add rule.</p>
</li>
<li>
<p>On the Rules page, you can do the following:</p>
<p>Type in the search field to filter results by rule name, description, and label. For example, type EC2 to return rules that evaluate EC2 resource types.</p>
</li>
<li>
<p>Select the following rules:</p>
<ul>
<li>ec2-instance-managed-by-systems-manager - Checks whether the Amazon EC2 instances in your account are managed by AWS Systems Manager.</li>
<li>ec2-managedinstance-patch-compliance-status-check - Checks whether the compliance status of the AWS Systems Manager patch compliance is COMPLIANT or NON_COMPLIANT after the patch installation on the instance.</li>
</ul>
</li>
</ol>
<p><strong>Analyzing your Fleet with Resource Groups</strong></p>
<ol>
<li>
<p>From within the Management Console, go to Systems Manager.</p>
</li>
<li>
<p>Click on Resource Groups and then Create Resource Group.</p>
</li>
<li>
<p>Choose <strong>CloudFormation stack based</strong> Group Type</p>
</li>
<li>
<p>Select the CloudFormation stack you created earlier and the resource type <em>AWS::EC2:Instance</em></p>
</li>
<li>
<p>Give the group and name and click Create Group</p>
</li>
<li>
<p>View Config Rule Compliance
    <img alt="Built In Insights" src="images/resource-groups-config-rule.png" /></p>
</li>
<li>
<p>For more details into the Resource Compliance status, click the Resource compliance drop-down.
    <img alt="Resource Compliance" src="images/resourcecompliance.png" /></p>
<p>You can get more details about these non-compliant instances from the AWS Config Console as well.
<img alt="Config Compliance" src="images/configcompliance.png" /></p>
</li>
<li>
<p>Click <strong>Inventory</strong> on the Navigation pane. You can now get more insights into your EC2 Fleet’s inventory. You can filter by resource groups, tags or inventory types.
    <img alt="Inventory Analysis" src="images/inventoryanalysis.png" /></p>
</li>
</ol>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../module3/" title="Module 3" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Module 3
              </span>
            </div>
          </a>
        
        
          <a href="../contribute/" title="Contributing" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Contributing
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://awssecworkshops.com" class="md-footer-social__link fa fa-home"></a>
    
      <a href="https://aws.amazon.com/security/" class="md-footer-social__link fa fa-shield"></a>
    
      <a href="https://twitter.com/awssecurityinfo?lang=en" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://aws.amazon.com/blogs/security/" class="md-footer-social__link fa fa-rss"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>